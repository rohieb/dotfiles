#!/bin/sh
red="\e[31m"
green="\e[32m"
yellow="\e[33m"
normal="\e[0m"

demicro() {
	echo "scale=2; $1 / 1000000" | bc
}

output_power() {
	BAT="$1"
	status=$(cat ${BAT}/status)
	energy_uWh=$(cat ${BAT}/energy_now)
	energy_Wh=$(demicro "${energy_uWh}")
	energy_full_uWh=$(cat ${BAT}/energy_full)
	capacity_percent=$(cat ${BAT}/capacity)
	power_uW=$(cat ${BAT}/power_now)
	power_W=$(demicro "${power_uW}")

	printf "%s" "$(basename ${BAT}): "

	if [ "${status}" = "Discharging" ]; then
		color="${yellow}"
	elif [ "${status}" = "Charging" ] || [ "${status}" = "Full" ]; then
		color="${green}"
	else
		color="${normal}"
	fi
	printf "${color}%s${normal}, " "${status}"

	if [ "${capacity_percent}" -lt 10 ]; then
		color="${red}"
	elif [ "${capacity_percent}" -lt 25 ]; then
		color="${yellow}"
	else
		color="${green}"
	fi
	printf "${color}%d%%${normal} (%s Wh)" "${capacity_percent}" "${energy_Wh}"

	if [ "${power_uW}" -gt 0 ]; then
		if [ "${status}" = "Discharging" ]; then
			hours=$((energy_uWh / power_uW)) || '0'
			minutes=$(echo "(${energy_uWh} / ${power_uW} - ${hours}) * 60" | bc -l)
			minutes=$(echo ${minutes} | cut -f 1 -d .)
			minutes=$(printf '%.2d' ${minutes})
			if [ "${hours}" -lt 1 ] && [ "${minutes}" -lt 30 ]; then
				color="${red}"
			elif [ "${hours}" -lt 2 ]; then
				color="${yellow}"
			else
				color="${green}"
			fi
		elif [ "${status}" = "Charging" ]; then
			energy_left_uWh=$((energy_full_uWh - energy_uWh))
			hours=$((energy_left_uWh / power_uW)) || '0'
			minutes=$(echo "(${energy_left_uWh} / ${power_uW} - ${hours}) * 60" | bc -l)
			color="${normal}"
		fi
		minutes=$(echo ${minutes} | cut -f 1 -d .)
		minutes=$(printf '%.2d' ${minutes})
		printf ", about ${color}%dh%dm${normal} left (at %.2f W)" "${hours}" "${minutes}" "${power_W}"
	fi
	echo
}

for bat in /sys/class/power_supply/BAT*; do
	output_power ${bat};
done
