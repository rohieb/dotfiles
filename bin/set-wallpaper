#!/bin/sh
# wallpapers are selected randomly from this folder:
FOLDER=$HOME/.wallpapers

# Nothing below this line needs to be changed.
LASTWALLPAPER=$HOME/.cache/last_wallpaper
LOGFILE="$HOME/.set-wallpaper.log"
log() {
	echo `date -R` $@ |tee -a $LOGFILE
}

rememberwallpaper() {
	if [ "$1" != "" -a "(" -f "$1" -o -L "$1" ")" -a -r "$1" ]; then
		if [ -f "$LASTWALLPAPER" -o -L "$LASTWALLPAPER" ]; then
			rm "$LASTWALLPAPER"
		fi
		ln -s "$1" "$LASTWALLPAPER"
		log Remembering wallpaper: "$1"
	fi
}

if [ "$1" = "-h" -o "$1" = "--help" ]; then
	echo Usage: `basename $0` '<FILE>'
	echo        `basename $0` '[--new|-n|--help|-h]'
	echo Wrapper for awsetbg to set and remember the Awesome wallpaper.
	echo With a file name as a single argument, sets and remembers the wallpaper.
	echo Without arguments, sets the wallpaper which was last used.
	echo
	echo "  --help|-h  Show this help message"
	echo "  --new|-n   Set and remember a random wallpaper from the rotation folder"
	echo
	echo Your rotation folder is currently:
	echo "  $FOLDER"
	echo "(to change this folder, edit $0.)"
	exit 0
fi

if [ "$1" = "--new" -o "$1" = "-n" ]; then
	rand_picture=`find "$FOLDER/" -iname "*.svg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.jpg" 2>/dev/null | shuf | head -n 1`
	rememberwallpaper "$rand_picture"
elif [ -n "$1" -a -f "$1" -a -r "$1" ]; then
	log Requested wallpaper: "$1"
	rememberwallpaper "$1"
else
	log Setting old wallpaper: `ls -l "$LASTWALLPAPER"`
fi;

awsetbg -a "$LASTWALLPAPER"
