#!/bin/sh

# Stream a video with mplayer
# Takes Video URL as first argument and passes all other arguments to mplayer
# Tested with: Vimeo, YouTube, TED.
# Needs:
# * mplayer, http://www.mplayerhq.hu/
# * quvi, http://quvi.sourceforge.net/

format="default"  # for Vimeo, this simply defaults to "sd"
if [ $1 = "-f" ]; then
	format=$2
	shift 2
fi;

video_url=$1
shift

mplayer_opts="-cache 2048 -msglevel all=1 $*"
quvi_opts="-v quiet"

set -e
formats=`quvi $quvi_opts -F "$video_url"|cut -d ':' -f 1`
set +e

echo Available formats: $formats

# choose YouTube quality
if [ "$format" = "default" ]; then
	for f in fmt35_480p fmt44_480p fmt34_360p fmt18_360p fmt43_360p fmt05_240p; do
		if echo $formats|grep -qw $f; then
			format=$f
			break;
		fi;
	done;
fi;

echo Choosing quality $format
echo mplayer options: $mplayer_opts
quvi $quvi_opts -f $format --exec "mplayer $mplayer_opts %u" "$video_url"

